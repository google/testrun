#bin/bash

NET_MODULES_DIR=modules/network
TEST_MODULES_DIR=modules/test
DEVICE_MODULES_DIR=modules/devices
BUILD_LOG_DIR=build

rm -rf $BUILD_LOG_DIR
mkdir $BUILD_LOG_DIR

function build_module {
  echo Building module $MODULE
  MODULE=$1
  MODULE_DIR=$2
  TAG=$3

  docker build -f $MODULE_DIR/$MODULE.Dockerfile -t test-run/$TAG . &> $BUILD_LOG_DIR/$TAG.log
  echo Finished building module $MODULE
}

# Build network modules
build_module base modules/network/base base

for f in $NET_MODULES_DIR/*; do
    if [ -d "$f" ]; then
      MODULE_NAME=$(basename $f)
      if [ $MODULE_NAME != "base" ] && [ $MODULE_NAME != "template" ]; then
        build_module $MODULE_NAME $NET_MODULES_DIR/$MODULE_NAME $MODULE_NAME
      fi
    fi
done

# Build test modules
build_module base modules/test/base base-test

for f in $TEST_MODULES_DIR/*; do
    if [ -d "$f" ]; then
      MODULE_NAME=$(basename $f)
      if [ $MODULE_NAME != "base" ] && [ $MODULE_NAME != "template" ]; then
        build_module $MODULE_NAME $TEST_MODULES_DIR/$MODULE_NAME $MODULE_NAME-test
      fi
    fi
done

# Build device modules
for f in $DEVICE_MODULES_DIR/*; do
    if [ -d "$f" ]; then
      MODULE_NAME=$(basename $f)
      if [ $MODULE_NAME != "base" ] && [ $MODULE_NAME != "template" ]; then
        build_module $MODULE_NAME $DEVICE_MODULES_DIR/$MODULE_NAME $MODULE_NAME
      fi
    fi
done